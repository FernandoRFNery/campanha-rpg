<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guia da Campanha D&D 5e — Realtime (v6.2)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
/* --- Dice icons grid: 2 colunas fixas --- */
.dice-roller .dice-buttons{
  display: grid;
  grid-template-columns: repeat(2, 96px);  /* 2 colunas fixas */
  gap: 16px 22px;                           /* espaçamento entre itens */
  width: fit-content;                        /* encolhe à largura do conteúdo */
  margin: 10px auto 0;                       /* centraliza dentro do card */
  justify-items: center;                     /* centraliza cada item */
  align-items: center;
}

/* cada botão é “quadrado” e não estica */
.dice-btn{
  display: block;
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
}

/* tamanho uniforme dos ícones */
.dice-btn img{
  width: 84px;
  height: 84px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(251,191,36,.14), rgba(217,70,239,.14));
  border: 1px solid var(--glass-border);
  padding: 10px;
  transition: transform .15s ease, box-shadow .2s ease;
  display: block;
}
.dice-btn:hover img{
  transform: translateY(-2px) scale(1.03);
  box-shadow: var(--shadow-sm);
}

/* opcional: resultado centralizado */
.dice-roller .dice-result{
  margin-top: 12px;
  text-align: center;
  font-weight: 600;
}

/* responsivo opcional (telas bem estreitas) */
@media (max-width: 420px){
  .dice-roller .dice-buttons{ grid-template-columns: repeat(2, 84px); }
  .dice-btn img{ width: 72px; height: 72px; padding: 8px; }
}



/* opcional: centraliza o resultado do roll */
.dice-roller .dice-result{
  margin-top: 10px;
  text-align: center;
  font-weight: 600;
}

    :root {
      --bg-grad: linear-gradient(135deg, #0d1421 0%, #1a1b3a 50%, #2d1b69 100%);
      --bg-solid: #0d1421;
      --panel: rgba(30, 41, 59, 0.95);
      --panel-2: rgba(15, 23, 42, 0.9);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #fbbf24;
      --accent-2: #d946ef;
      --grid: rgba(148, 163, 184, 0.2);
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
      --glass: rgba(255,255,255,.05); --glass-border: rgba(255,255,255,.1);
      --shadow: 0 25px 50px -12px rgba(0,0,0,.5); --shadow-sm: 0 4px 6px -1px rgba(0,0,0,.3);
    }
    html[data-theme="light"] {
      --bg-grad: linear-gradient(135deg, #fef7cd 0%, #fef3c7 50%, #fde68a 100%);
      --bg-solid: #fef7cd;
      --panel: rgba(255,255,255,.92);
      --panel-2: rgba(254,252,232,.95);
      --text: #1f2937; --text-muted:#6b7280;
      --accent: #b45309; --accent-2:#7c2d12;
      --grid: rgba(107,114,128,.3);
      --glass: rgba(0,0,0,.05); --glass-border: rgba(0,0,0,.1);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;min-height:100vh;background:var(--bg-grad);color:var(--text);font-family:'Crimson Text', serif;font-size:16px;line-height:1.6}
    body::before{content:'';position:fixed;inset:0;pointer-events:none;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;z-index:-1}
    header{position:sticky;top:0;z-index:100;backdrop-filter:blur(20px) saturate(180%);background:rgba(13,20,33,.8);border-bottom:2px solid var(--accent);box-shadow:var(--shadow)}
    header .wrap{max-width:1400px;margin:0 auto;padding:16px 24px;display:flex;align-items:center;gap:16px}
    h1{margin:0;font-family:'Cinzel',serif;font-size:24px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .h-spacer{flex:1}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--glass-border);color:var(--text);border-radius:12px;padding:10px 14px;cursor:pointer;font-family:'Cinzel',serif;font-weight:600;display:flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#f59e0b);color:#000;border:none}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;border:none}
    .btn.active{background:var(--accent);color:#000}
    main{max-width:1400px;margin:0 auto;padding:32px 24px 80px;display:grid;grid-template-columns:300px 1fr;gap:32px}
    nav#toc{position:sticky;top:120px;align-self:start;background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;padding:20px;box-shadow:var(--shadow)}
    #toc h3{margin:0 0 12px;font-family:'Cinzel',serif;color:var(--accent);text-align:center}
    #toc a{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:8px 0;border-radius:12px;color:var(--text);text-decoration:none;border:1px solid transparent}
    #toc a:hover{background:var(--glass);border-color:var(--accent);transform:translateX(4px)}
    .quick-stats,.dice-roller,.party-tracker,.notes{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--glass-border);border-radius:16px;padding:16px;margin-top:18px}
    .quick-stats h4,.dice-roller h4,.party-tracker h4,.notes h3{margin:0 0 10px;font-family:'Cinzel',serif;color:var(--accent);text-align:center}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:center}
    .stat-item{background:rgba(0,0,0,.2);padding:8px;border-radius:10px;border:1px solid var(--grid)}
    .stat-number{font-weight:700;color:var(--accent)}
    section.block{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;margin-bottom:24px;overflow:hidden;box-shadow:var(--shadow)}
    details.section>summary{list-style:none;cursor:pointer;background:linear-gradient(135deg,rgba(251,191,36,.12),rgba(217,70,239,.12));padding:18px 20px;border-bottom:1px solid var(--grid)}
    details.section>summary h2{margin:0;display:inline-flex;align-items:center;gap:10px;font-family:'Cinzel',serif;font-size:20px;color:var(--accent)}
    details.section[open]>summary{background:linear-gradient(135deg,rgba(251,191,36,.15),rgba(217,70,239,.15))}
    .controls{display:flex;gap:10px;padding:12px 16px;border-bottom:1px dashed var(--grid);flex-wrap:wrap;background:rgba(0,0,0,.1);align-items:center}
    .controls input[type="search"]{flex:1;min-width:200px;background:rgba(0,0,0,.2);color:var(--text);border:1px solid var(--grid);border-radius:12px;padding:10px 14px}
    .controls .btn.small{padding:8px 12px;border-radius:10px;font-size:14px}
    .table-wrap{overflow:auto;max-height:600px}
    table.grid{width:100%;border-collapse:collapse;min-width:820px}
    table.grid th,table.grid td{border-bottom:1px solid var(--grid);padding:12px 14px;vertical-align:top}
    table.grid thead th{position:sticky;top:0;background:rgba(13,20,33,.95);backdrop-filter:blur(10px);z-index:10;cursor:pointer;font-family:'Cinzel',serif;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--accent)}
    table.grid tbody tr:hover{background:rgba(251,191,36,.05)}
    th.sort-asc::after{content:" ▲";color:var(--accent)} th.sort-desc::after{content:" ▼";color:var(--accent)}
    td.actions,th.actions{width:180px;text-align:center}
    .row-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .row-actions .btn{padding:6px 10px;border-radius:8px;font-size:12px}
    .tag{padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700;display:inline-block;text-transform:uppercase;letter-spacing:.4px}
    .yes{background:var(--success);color:#fff}.maybe{background:var(--warning);color:#000}.no{background:var(--danger);color:#fff}
    ul.bullets{margin:0;padding:16px 24px}
    ul.bullets li{margin:10px 0;display:flex;gap:14px;align-items:flex-start;background:rgba(0,0,0,.1);padding:12px 14px;border-radius:12px;border-left:4px solid var(--accent)}
    ul.bullets .text{flex:1}
    .inline-form{display:none;gap:10px;flex-wrap:wrap;padding:16px 18px;border-top:1px dashed var(--grid);background:rgba(0,0,0,.1)}
    .inline-form input,.inline-form textarea,.inline-form select{background:rgba(0,0,0,.2);color:var(--text);border:1px solid var(--grid);border-radius:10px;padding:10px 12px}
    .inline-form textarea{min-height:80px;flex-basis:100%;resize:vertical}
    .snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,.9);color:#fff;padding:12px 18px;border-radius:12px;display:none;gap:12px;align-items:center;box-shadow:var(--shadow);border:1px solid var(--accent)}
    @media(max-width:1200px){main{grid-template-columns:1fr}nav#toc{position:relative;top:auto}}
    @media print{header,nav#toc,.controls,.btn,.inline-form,.snackbar,.notes,.dice-roller,.party-tracker{display:none}main{grid-template-columns:1fr}section.block{box-shadow:none;break-inside:avoid}}
  /* --- Party tracker --- */
.party-tracker .party-member{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:6px 8px;
  border-radius:10px;
}

.party-tracker .level-wrap{
  display:flex;
  align-items:center;
  gap:6px;
  color:var(--text-muted);
  font-weight:600;
}

.party-tracker .member-level[contenteditable="true"]{
  min-width:32px;
  text-align:center;
  color:var(--text);
  background:rgba(0,0,0,.2);
  border:1px solid var(--glass-border);
  border-radius:8px;
  padding:2px 10px;
  outline:none;
}
.party-tracker .member-level[contenteditable="true"]:empty::before{
  content:'?';
  color:var(--text-muted);
}
/* --- FIX: tabelas estáveis e header alinhado --- */
.table-wrap{
  overflow: auto;
  max-height: 600px;
  /* reserva o espaço do scrollbar para evitar “salto” de largura */
  scrollbar-gutter: stable both-edges;
  /* usado como fallback via JS */
  --sbw: 0px;
}

/* largura fixada para manter as colunas alinhadas */
table.grid{
  width: 100%;
  table-layout: fixed;
}

/* quebra de linha adequada em células longas */
table.grid th, table.grid td{
  word-break: break-word;
}

/* fallback para browsers sem suporte a `scrollbar-gutter`:
   adiciona o “gutter” no header para bater com o body */
.table-wrap thead th:last-child{
  padding-right: var(--sbw);
}
/* --- PATCH: Notes não extrapola o card --- */
.notes{
  overflow: hidden;                 /* se algo tentar sair, corta */
}

.notes textarea#quickNotes{
  width: 100%;                      /* ocupa o card, sem passar */
  max-width: 100%;                  /* impede resize horizontal além do card */
  min-height: 140px;                /* ajuste livre */
  resize: vertical;                 /* permite só altura */
  display: block;
  box-sizing: border-box;
  background: rgba(0,0,0,.2);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: var(--text);
  padding: 10px 12px;
  outline: none;
}
/* ===== LIGHT THEME TWEAKS — v2 (um pouco mais escuro) ===== */

/* 1) Barra do topo (header) mais fechada no claro */
html[data-theme="light"] header{
  background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.18));
  border-bottom-color: var(--accent);
}
html[data-theme="light"] header .btn{
  background: rgba(0,0,0,.12);
  border-color: rgba(0,0,0,.20);
  color: var(--text);
}

/* 2) Cabeçalhos das seções (summary) com gradiente menos “lavado” */
html[data-theme="light"] details.section > summary{
  background: linear-gradient(135deg,
    rgba(251,191,36,.18),
    rgba(217,70,239,.14)
  );
}
html[data-theme="light"] details.section[open] > summary{
  background: linear-gradient(135deg,
    rgba(251,191,36,.22),
    rgba(217,70,239,.16)
  );
}

/* 3) Thead das tabelas levemente mais escuro para destacar do corpo */
html[data-theme="light"] table.grid thead th{
  background: rgba(0,0,0,.14);
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}

/* 4) “Dados Rápidos”: tiles mais fechados no claro */
html[data-theme="light"] .dice-roller .dice-buttons .dice-btn img{
  background: linear-gradient(135deg,
    rgba(0,0,0,.10),
    rgba(0,0,0,.08)
  );
  border-color: rgba(0,0,0,.18);
}
html[data-theme="light"] .dice-roller .dice-result{
  color: var(--text);
  opacity: .9;
}
/* Tiles dos dados (passam a usar SVG inline) */
.dice-btn{
  display: block;
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
  color: var(--accent); /* ouro no dark, âmbar escuro no light */
}

.dice-btn svg{
  width: 30px; height: 30px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(0,0,0,.10), rgba(0,0,0,.08));
  border: 1px solid var(--glass-border);
  padding: 10px;
  box-sizing: content-box;
  transition: transform .15s ease, box-shadow .2s ease;
  display: block;
}
.dice-btn:hover svg{ transform: translateY(-2px) scale(1.03); box-shadow: var(--shadow-sm); }

/* Light theme: fundo um pouco mais claro, mas a cor vem de var(--accent) */
html[data-theme="light"] .dice-roller .dice-buttons .dice-btn svg{
  background: linear-gradient(135deg, rgba(0,0,0,.06), rgba(0,0,0,.05));
  border-color: rgba(0,0,0,.18);
}
/* ===== Column widths por seção (melhor uso do espaço) ===== */
/* mantém o cabeçalho alinhado e dá folga às colunas longas */

table.grid{ table-layout: fixed; } /* já deve existir; manter */

/* DETALHES DA CAMPANHA */
#detalhes-tbl th:nth-child(1), #detalhes-tbl td:nth-child(1){ width:18%; }
#detalhes-tbl th:nth-child(2), #detalhes-tbl td:nth-child(2){ width:52%; } /* Informação – maior */
#detalhes-tbl th:nth-child(3), #detalhes-tbl td:nth-child(3){ width:12%; text-align:center; } /* Símbolo */
#detalhes-tbl th:nth-child(4), #detalhes-tbl td:nth-child(4){ width:10%; } /* Facção */
#detalhes-tbl th.actions,      #detalhes-tbl td.actions      { width:160px; }

/* LUGARES */
#lugares-tbl  th:nth-child(1), #lugares-tbl  td:nth-child(1){ width:68%; } /* Local – maior */
#lugares-tbl  th:nth-child(2), #lugares-tbl  td:nth-child(2){ width:14%; text-align:center; } /* Visitado? */
#lugares-tbl  th.actions,      #lugares-tbl  td.actions      { width:160px; }

/* NPCs */
#npcs-tbl     th:nth-child(1), #npcs-tbl     td:nth-child(1){ width:14%; } /* Nome */
#npcs-tbl     th:nth-child(2), #npcs-tbl     td:nth-child(2){ width:12%; } /* Detalhe */
#npcs-tbl     th:nth-child(3), #npcs-tbl     td:nth-child(3){ width:14%; } /* Quest */
#npcs-tbl     th:nth-child(4), #npcs-tbl     td:nth-child(4){ width:12%; } /* Localidade */
#npcs-tbl     th:nth-child(5), #npcs-tbl     td:nth-child(5){ width:34%; } /* O que sabe? – maior */
#npcs-tbl     th:nth-child(6), #npcs-tbl     td:nth-child(6){ width:8%;  text-align:center; } /* Relevância */
#npcs-tbl     th.actions,      #npcs-tbl     td.actions      { width:180px; }

/* EVENTOS (Timeline) */
#eventos-tbl  th:nth-child(1), #eventos-tbl  td:nth-child(1){ width:14%; white-space:nowrap; } /* Data */
#eventos-tbl  th:nth-child(2), #eventos-tbl  td:nth-child(2){ width:26%; } /* Evento */
#eventos-tbl  th:nth-child(3), #eventos-tbl  td:nth-child(3){ width:52%; } /* Notas – maior */
#eventos-tbl  th.actions,      #eventos-tbl  td.actions      { width:160px; }

/* ITENS & TESOUROS */
#itens-tbl    th:nth-child(1), #itens-tbl    td:nth-child(1){ width:18%; } /* Item */
#itens-tbl    th:nth-child(2), #itens-tbl    td:nth-child(2){ width:14%; } /* Tipo */
#itens-tbl    th:nth-child(3), #itens-tbl    td:nth-child(3){ width:14%; } /* Dono */
#itens-tbl    th:nth-child(4), #itens-tbl    td:nth-child(4){ width:14%; } /* Local */
#itens-tbl    th:nth-child(5), #itens-tbl    td:nth-child(5){ width:32%; } /* Notas – maior */
#itens-tbl    th.actions,      #itens-tbl    td.actions      { width:160px; }

/* Quebra melhor de textos longos */
table.grid th, table.grid td{ word-break: break-word; }

/* ===== TABELAS: cabeçalho mais legível e coluna Ações compacta ===== */
:root{ --actions-col: 112px; }   /* largura fixa pra coluna de Ações */

table.grid{ table-layout: fixed; }  /* mantém header/body alinhados */

table.grid th, table.grid td{
  padding: 10px 12px;
  vertical-align: top;
  word-break: break-word;
}

table.grid thead th{
  font-size: 13.5px;
  line-height: 1.25;
  text-transform: uppercase;
  letter-spacing: .04em;
  white-space: nowrap;         /* não quebra o header */
  overflow: hidden;
  text-overflow: ellipsis;     /* usa … se apertar */
  padding-right: 18px;         /* espaço p/ indicador */
}

td.actions, th.actions{
  width: var(--actions-col);
  text-align: center;
}

/* Zebra suave para leitura */
table.grid tbody tr:nth-child(odd){ background: rgba(0,0,0,.06); }
html[data-theme="light"] table.grid tbody tr:nth-child(odd){ background: rgba(0,0,0,.04); }

/* ===== ÍCONES nos botões de Ações ===== */
.row-actions{ display:flex; gap:8px; justify-content:center; align-items:center; }

.btn.icon-btn{
  width: 38px; height: 34px; padding: 0;
  border-radius: 10px;
  display:inline-flex; align-items:center; justify-content:center;
  background: rgba(0,0,0,.10);
  border: 1px solid var(--glass-border);
  color: var(--text);
}
.btn.icon-btn:hover{ box-shadow: var(--shadow-sm); transform: translateY(-1px); }
.btn.icon-btn.danger{ color:#fff; background: linear-gradient(135deg,#ef4444,#dc2626); border:none; }
.btn.icon-btn i{ font-size: 14px; line-height: 1; }

/* ===== Indicador de ordenação no hover do cabeçalho ===== */
table.grid thead th:not(.actions):not(.sort-asc):not(.sort-desc):hover::after{
  content: ' ⇅';              /* aparece só ao passar o mouse em colunas não ordenadas */
  color: var(--accent);
  opacity: .7;
}
th.sort-asc::after{  content: " ▲"; color: var(--accent); }
th.sort-desc::after{ content: " ▼"; color: var(--accent); }

  

/* ===== PATCHES ADICIONADOS ===== */

/* Notes não extrapola o card */
.notes{ overflow: hidden; }
.notes textarea#quickNotes{
  width:100%; max-width:100%; min-height:140px; resize:vertical; display:block;
  box-sizing:border-box; background:rgba(0,0,0,.2); border:1px solid var(--glass-border);
  border-radius:10px; color:var(--text); padding:10px 12px; outline:none;
}

/* Dice icons: grade centralizada (2 colunas) e SVG com currentColor */
.dice-roller .dice-buttons{
  display:grid;
  grid-template-columns: repeat(2, 96px);
  gap:16px 22px;
  width:fit-content;
  margin:10px auto 0;
  justify-items:center;
  align-items:center;
}
.dice-btn{ display:block; background:transparent; border:none; padding:0; cursor:pointer; color:var(--accent); }
.dice-btn svg{
  width:84px; height:84px;
  border-radius:14px;
  background:linear-gradient(135deg, rgba(0,0,0,.10), rgba(0,0,0,.08));
  border:1px solid var(--glass-border);
  padding:10px; box-sizing:content-box;
  transition:transform .15s ease, box-shadow .2s ease; display:block;
}
.dice-btn:hover svg{ transform:translateY(-2px) scale(1.03); box-shadow:var(--shadow-sm); }
html[data-theme="light"] .dice-roller .dice-buttons .dice-btn svg{
  background:linear-gradient(135deg, rgba(0,0,0,.06), rgba(0,0,0,.05));
  border-color:rgba(0,0,0,.18);
}

/* Party tracker: nível editável visual */
.party-tracker .party-member{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 8px; border-radius:10px; }
.party-tracker .level-wrap{ display:flex; align-items:center; gap:6px; color:var(--text-muted); font-weight:600; }
.party-tracker .member-level[contenteditable]{ cursor:text; }
.party-tracker .member-level[contenteditable="true"]{
  min-width:32px; text-align:center; color:var(--text);
  background:rgba(0,0,0,.2); border:1px solid var(--glass-border);
  border-radius:8px; padding:2px 10px; outline:none;
}
.party-tracker .member-level[contenteditable="true"]:empty::before{ content:'?'; color:var(--text-muted); }

/* Header/tables alignment + fallback gutter */
.table-wrap{
  overflow:auto; max-height:600px;
  scrollbar-gutter: stable both-edges;
  --sbw: 0px;
}
table.grid{ width:100%; table-layout:fixed; }
table.grid th, table.grid td{ word-break: break-word; }

/* Cabeçalho mais legível e coluna ações compacta */
:root{ --actions-col: 112px; }
table.grid th, table.grid td{ padding:10px 12px; vertical-align:top; }
table.grid thead th{
  font-size:13.5px; line-height:1.25; text-transform:uppercase; letter-spacing:.04em;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:18px;
}
td.actions, th.actions{ width:var(--actions-col); text-align:center; }

/* Zebra suave */
table.grid tbody tr:nth-child(odd){ background: rgba(0,0,0,.06); }
html[data-theme="light"] table.grid tbody tr:nth-child(odd){ background: rgba(0,0,0,.04); }

/* Indicador de ordenação */
table.grid thead th:not(.actions):not(.sort-asc):not(.sort-desc):hover::after{
  content:' ⇅'; color:var(--accent); opacity:.7;
}
th.sort-asc::after{ content:' ▲'; color:var(--accent); }
th.sort-desc::after{ content:' ▼'; color:var(--accent); }

/* Ações por ícones */
.row-actions{ display:flex; gap:8px; justify-content:center; align-items:center; }
.btn.icon-btn{
  width:38px; height:34px; padding:0; border-radius:10px;
  display:inline-flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.10); border:1px solid var(--glass-border); color:var(--text);
}
.btn.icon-btn:hover{ box-shadow:var(--shadow-sm); transform: translateY(-1px); }
.btn.icon-btn.danger{ color:#fff; background: linear-gradient(135deg,#ef4444,#dc2626); border:none; }
.btn.icon-btn i{ font-size:14px; line-height:1; }

/* Light theme tweaks v2 */
html[data-theme="light"] header{
  background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.18));
  border-bottom-color: var(--accent);
}
html[data-theme="light"] header .btn{
  background: rgba(0,0,0,.12);
  border-color: rgba(0,0,0,.20);
  color: var(--text);
}
html[data-theme="light"] details.section > summary{
  background: linear-gradient(135deg, rgba(251,191,36,.18), rgba(217,70,239,.14));
}
html[data-theme="light"] details.section[open] > summary{
  background: linear-gradient(135deg, rgba(251,191,36,.22), rgba(217,70,239,.16));
}
html[data-theme="light"] table.grid thead th{
  background: rgba(0,0,0,.14);
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}
/* ===== Dice: efeitos de CRÍTICO / FALHA ===== */
:root{
  --crit-max: #facc15; /* amarelo-ouro */
  --crit-min: #ef4444; /* vermelho */
}

@keyframes dice-shake {
  0%{transform:translate(0,0) rotate(0)}
  20%{transform:translate(-2px,2px) rotate(-10deg)}
  40%{transform:translate(3px,-2px) rotate(8deg)}
  60%{transform:translate(-2px,1px) rotate(-6deg)}
  80%{transform:translate(1px,-1px) rotate(4deg)}
  100%{transform:translate(0,0) rotate(0)}
}
@keyframes result-pulse {
  0%{transform:scale(1);opacity:.95}
  50%{transform:scale(1.08);opacity:1}
  100%{transform:scale(1);opacity:.95}
}
@keyframes ring-pop {
  from{transform:translate(-50%,-50%) scale(.9);opacity:.9}
  to{transform:translate(-50%,-50%) scale(1.3);opacity:0}
}
@keyframes crit-pop {
  0%{transform:scale(1)}
  40%{transform:scale(1.12)}
  100%{transform:scale(1)}
}

/* animação base da rolagem (já usada) */
.dice-btn.rolling svg{ animation: dice-shake 650ms cubic-bezier(.2,.8,.2,1); filter: drop-shadow(0 6px 10px rgba(0,0,0,.25)); }
.dice-roller .dice-result.rolling{ animation: result-pulse 650ms ease-in-out; }

/* preparar o botão pro anel de crítico */
.dice-btn{ position: relative; overflow: visible; }

/* crítico (máximo) – brilho dourado + anel */
.dice-btn.crit-max{ color: var(--crit-max); }
.dice-btn.crit-max svg{ filter: drop-shadow(0 0 10px rgba(250,204,21,.55)); }
.dice-btn.crit-max::after{
  content:''; position:absolute; left:50%; top:50%; width:88px; height:88px;
  border-radius:16px; border:2px solid var(--crit-max); pointer-events:none;
  animation: ring-pop 700ms ease-out forwards;
}

/* falha crítica (1) – vermelho */
.dice-btn.crit-min{ color: var(--crit-min); }
.dice-btn.crit-min svg{ filter: drop-shadow(0 0 10px rgba(239,68,68,.5)); }
.dice-btn.crit-min::after{
  content:''; position:absolute; left:50%; top:50%; width:88px; height:88px;
  border-radius:16px; border:2px solid var(--crit-min); pointer-events:none;
  animation: ring-pop 700ms ease-out forwards;
}

/* resultado com pop colorido */
.dice-roller .dice-result.crit-max{
  color: var(--crit-max); text-shadow:0 0 8px rgba(250,204,21,.55);
  animation: crit-pop 700ms cubic-bezier(.2,.8,.2,1);
}
.dice-roller .dice-result.crit-min{
  color: var(--crit-min); text-shadow:0 0 8px rgba(239,68,68,.45);
  animation: crit-pop 700ms cubic-bezier(.2,.8,.2,1);
}

/* acessibilidade: reduz movimento */
@media (prefers-reduced-motion: reduce){
  .dice-btn.rolling svg,
  .dice-roller .dice-result.rolling,
  .dice-btn.crit-max::after,
  .dice-btn.crit-min::after{
    animation: none !important;
  }
}
/* ===== Container mais largo (header + main) ===== */
:root{
  /* ajuste aqui se quiser mais/menos largura */
  --container-max: 1680px;   /* antes era 1400px */
  --toc-w: 320px;            /* largura da barra lateral (antes ~300px) */
  --container-gap: 36px;     /* espaço entre TOC e conteúdo (antes 32px) */
}

/* alinha a largura do header e do conteúdo principal */
header .wrap{ max-width: var(--container-max); }
main{
  max-width: var(--container-max);
  grid-template-columns: var(--toc-w) 1fr;  /* TOC + conteúdo */
  gap: var(--container-gap);
}

/* um pouquinho mais em telas muito grandes, opcional */
@media (min-width: 1920px){
  :root{
    --container-max: 1800px;
    --toc-w: 340px;
  }
}
/* ===== Colunas redimensionáveis ===== */
table.grid thead th{ position: relative; } /* precisa para posicionar o grip */

.col-resizer{
  position: absolute;
  top: 0; right: -3px;         /* levemente para fora p/ facilitar o hover */
  width: 8px; height: 100%;
  cursor: col-resize;
  user-select: none;
  touch-action: none;
}
.col-resizer::before{
  content: '';
  position: absolute;
  left: 3px; top: 20%;
  width: 2px; height: 60%;
  background: rgba(0,0,0,.18);
  border-radius: 2px;
  opacity: 0;
  transition: opacity .15s ease;
}
table.grid thead th:hover .col-resizer::before{ opacity: .65; }
html[data-theme="light"] .col-resizer::before{ background: rgba(0,0,0,.28); }

/* feedback durante o drag */
body.is-col-resizing{ cursor: col-resize !important; user-select: none; }


</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><i class="fas fa-dragon"></i> Guia da Campanha Tico Duro - D&D 5e</h1>
      <div class="session-counter btn" id="sessionBox" title="Clique para aumentar">
        <i class="fas fa-calendar-alt"></i>
        Sessão <strong id="sessionCount">1</strong>
      </div>
      <div class="h-spacer"></div>
      <div class="toolbar">
        <button class="btn" id="themeToggle" title="Alternar tema"><i class="fas fa-moon"></i> Tema</button>
        <button class="btn" id="exportJson"><i class="fas fa-download"></i> JSON</button>
        <button class="btn" id="importJson"><i class="fas fa-upload"></i> Importar</button>
        <button class="btn" id="exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
        <button class="btn danger" id="resetAll"><i class="fas fa-trash-alt"></i> Reset</button>
      </div>
    </div>
  </header>

  <main>
    <nav id="toc">
      <h3><i class="fas fa-scroll"></i> Seções</h3>
      <a href="#detalhes"><i class="fas fa-info-circle"></i> Detalhes da Campanha</a>
      <a href="#lugares"><i class="fas fa-map-marked-alt"></i> Lugares</a>
      <a href="#npcs"><i class="fas fa-users"></i> NPCs</a>
      <a href="#missoes"><i class="fas fa-tasks"></i> Missões</a>
      <a href="#eventos"><i class="fas fa-hourglass-half"></i> Timeline</a>
      <a href="#itens"><i class="fas fa-gem"></i> Itens & Tesouros</a>

      <div class="quick-stats">
        <h4><i class="fas fa-chart-bar"></i> Estatísticas</h4>
        <div class="stats-grid">
          <div class="stat-item"><div class="stat-number" id="npcCount">0</div><div class="stat-label">NPCs</div></div>
          <div class="stat-item"><div class="stat-number" id="locationCount">0</div><div class="stat-label">Locais</div></div>
          <div class="stat-item"><div class="stat-number" id="questCount">0</div><div class="stat-label">Missões</div></div>
          <div class="stat-item"><div class="stat-number" id="itemCount">0</div><div class="stat-label">Itens</div></div>
        </div>
      </div>

      <div class="party-tracker">
        <h4><i class="fas fa-users"></i> Grupo</h4>
      
        <div class="party-member">
          <span class="member-name">Soren</span>
          <span class="level-wrap">
            <span class="level-label">Nível</span>
            <span class="member-level" contenteditable="true" spellcheck="false" tabindex="0">?</span>
          </span>
        </div>
      
        <div class="party-member">
          <span class="member-name">Tristan</span>
          <span class="level-wrap">
            <span class="level-label">Nível</span>
            <span class="member-level" contenteditable="true" spellcheck="false" tabindex="0">?</span>
          </span>
        </div>
      
        <div class="party-member">
          <span class="member-name">Eldrin</span>
          <span class="level-wrap">
            <span class="level-label">Nível</span>
            <span class="member-level" contenteditable="true" spellcheck="false" tabindex="0">?</span>
          </span>
        </div>
      </div>

      <div class="dice-roller">
        <h4><i class="fas fa-dice-d20"></i> Dados Rápidos</h4>
        <div class="dice-buttons">
  <button class="dice-btn" data-dice="4" aria-label="Rolar d4">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <polygon points="40,8 10,68 70,68" fill="none" stroke="currentColor" stroke-width="3"/>
      <text x="50%" y="58%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d4</text>
    </svg>
  </button>
  <button class="dice-btn" data-dice="6" aria-label="Rolar d6">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <rect x="12" y="12" width="56" height="56" rx="10" ry="10" fill="none" stroke="currentColor" stroke-width="3"/>
      <text x="50%" y="55%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d6</text>
    </svg>
  </button>
  <button class="dice-btn" data-dice="8" aria-label="Rolar d8">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <polygon points="40,10 10,40 40,70 70,40" fill="none" stroke="currentColor" stroke-width="3"/>
      <text x="50%" y="55%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d8</text>
    </svg>
  </button>
  <button class="dice-btn" data-dice="10" aria-label="Rolar d10">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <polygon points="40,8 15,28 12,52 40,72 68,52 65,28" fill="none" stroke="currentColor" stroke-width="3"/>
      <text x="50%" y="57%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d10</text>
    </svg>
  </button>
  <button class="dice-btn" data-dice="12" aria-label="Rolar d12">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <polygon points="40,6 20,16 10,36 14,56 30,70 50,70 66,56 70,36 60,16" fill="none" stroke="currentColor" stroke-width="3"/>
      <text x="50%" y="58%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d12</text>
    </svg>
  </button>
  <button class="dice-btn" data-dice="20" aria-label="Rolar d20">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
      <polygon points="40,6 12,26 12,54 40,74 68,54 68,26" fill="none" stroke="currentColor" stroke-width="3"/>
      <line x1="12" y1="26" x2="68" y2="54" stroke="currentColor" stroke-width="2" opacity=".6"/>
      <line x1="68" y1="26" x2="12" y2="54" stroke="currentColor" stroke-width="2" opacity=".6"/>
      <text x="50%" y="57%" text-anchor="middle" font-size="18" font-family="Cinzel" fill="currentColor">d20</text>
    </svg>
  </button>
</div>              
        <div class="dice-result" id="diceResult">Rolar dado</div>
      </div>

      <div class="notes">
        <h3><i class="fas fa-feather-alt"></i> Anotações Rápidas</h3>
        <textarea id="quickNotes" placeholder="Observações da sessão, loot, XP, pendências..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="saveNotes"><i class="fas fa-save"></i> Salvar</button><button class="btn" id="clearNotes"><i class="fas fa-eraser"></i> Limpar</button></div>
      </div>
    </nav>
    <div>
      <!-- Detalhes da Campanha -->
      <section class="block" id="detalhes-section">
        <details class="section" open>
          <summary><h2 id="detalhes"><i class="fas fa-info-circle"></i> Detalhes da Campanha</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-table="detalhes-tbl">
            <button class="btn small" data-edit-toggle="detalhes-tbl"><i class="fas fa-edit"></i> Modo Edição</button>
            <button class="btn small" data-add-toggle="detalhes"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small" data-export-csv="detalhes-tbl"><i class="fas fa-file-csv"></i> CSV</button>
            <button class="btn small danger" data-reset="detalhes"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="detalhes">
            <input placeholder="Quem sabe a info?" />
            <textarea placeholder="Informação"></textarea>
            <input placeholder="Símbolo" />
            <input placeholder="Facção" />
            <button class="btn primary" data-form-submit="detalhes">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <div class="table-wrap">
            <table class="grid" id="detalhes-tbl" data-sortable="true">
              <thead><tr><th>Quem sabe a info?</th><th>Informação</th><th>Símbolo</th><th>Facção</th><th class="actions">Ações</th></tr></thead>
              <tbody>
                <tr><td contenteditable="false">Soren Tristan Eldrin</td><td contenteditable="false">O velhote (do cervo): Tentei vir salvar alguém e acabei preso nesta floresta. Obrigado por libertarem meu espírito desta maldição. (Soren e Eldrin ouviram e Soren informou Tristan depois – Tristan sentiu a presença astral)</td><td contenteditable="false">Cervo</td><td contenteditable="false">?</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Soren Tristan Eldrin</td><td contenteditable="false">3 Zhentarim: Tudo isso por causa do maldito do Marrick. / Aquele filho da puta nos mandou pra morte! / Desgraçado, ficamos presos na floresta por culpa dele. (Tristan ouviu e informou Soren e Eldrin depois – Soren sentiu a presença astral, Eldrin não sentiu nada, nem remorso hehehe)</td><td contenteditable="false">Serpente Alada</td><td contenteditable="false">Zhentarim</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Eldrin</td><td contenteditable="false">2 Zhentarim: Aquele corno! Vivem pra morrer por causa dele! / Tudo isso por causa daquele desgraçado do Marrick e seu esquema de raptar pessoas! (Eldrin ouviu, mas não informou Tristan nem Soren depois – Soren sentiu a presença, mas Tristan não)</td><td contenteditable="false">Serpente Alada</td><td contenteditable="false">Zhentarim</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Eldrin</td><td contenteditable="false">A mulher (do cervo): Tentei salvar uma pessoa e acabei ficando presa pelo poder do nosso próprio povo sem conseguir voltar para Torntrad. Obrigado por terem libertado meu espírito, tentarei chegar à forma astral. (Eldrin ouviu, mas não informou Tristan nem Soren depois – Soren sentiu a presença, mas Tristan não)</td><td contenteditable="false">Cervo</td><td contenteditable="false">?</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Soren Tristan Eldrin</td><td contenteditable="false">O homem imponente (da coroa): Conseguimos seguir os Zhentarim até aqui e eliminar todos, mas ficamos presos nesse labirinto mágico. As tropas da nossa aliança conseguiram derrubar muitos Zhentarim, mas a preço alto. Espero que os demais lordes consigam pôr um fim nisso. Obrigado por libertarem meu espírito. (Soren e Eldrin ouviram e Soren informou Tristan depois – Tristan sentiu a presença)</td><td contenteditable="false">Coroa</td><td contenteditable="false">?</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Eldrin</td><td contenteditable="false">Cespemar se manifesta novamente, mas desta vez não como goblinóide, mas sim como changeling (muito similar ao Soren fisicamente).</td><td contenteditable="false">Ring of Bhaal</td><td contenteditable="false">Bhaal's Cult</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
              </tbody>
            </table>
          </div>
        </details>
      </section>

      <!-- Lugares -->
      <section class="block" id="lugares-section">
        <details class="section" open>
          <summary><h2 id="lugares"><i class="fas fa-map-marked-alt"></i> Lugares</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-table="lugares-tbl">
            <button class="btn small" data-edit-toggle="lugares-tbl"><i class="fas fa-edit"></i> Modo Edição</button>
            <button class="btn small" data-add-toggle="lugares"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small" data-export-csv="lugares-tbl"><i class="fas fa-file-csv"></i> CSV</button>
            <button class="btn small danger" data-reset="lugares"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="lugares">
            <input placeholder="Local" />
            <select>
              <option value="✔️">✔️ Visitado</option>
              <option value="—">— Não</option>
            </select>
            <button class="btn primary" data-form-submit="lugares">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <div class="table-wrap">
            <table class="grid" id="lugares-tbl" data-sortable="true">
              <thead><tr><th>Local</th><th>Visitado?</th><th class="actions">Ações</th></tr></thead>
              <tbody>
                <tr><td contenteditable="false">Bliveholde</td><td contenteditable="false">✔️</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Sylvaris</td><td contenteditable="false">—</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Torntrad</td><td contenteditable="false">—</td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
              </tbody>
            </table>
          </div>
        </details>
      </section>
      <!-- NPCs -->
      <section class="block" id="npcs-section">
        <details class="section" open>
          <summary><h2 id="npcs"><i class="fas fa-users"></i> NPCs</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-table="npcs-tbl">
            <button class="btn small" data-edit-toggle="npcs-tbl"><i class="fas fa-edit"></i> Modo Edição</button>
            <button class="btn small" data-add-toggle="npcs"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small" data-export-csv="npcs-tbl"><i class="fas fa-file-csv"></i> CSV</button>
            <button class="btn small danger" data-reset="npcs"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="npcs">
            <input placeholder="Nome" />
            <input placeholder="Detalhe" />
            <input placeholder="Quest" />
            <input placeholder="Localidade" />
            <textarea placeholder="O que sabe?"></textarea>
            <select>
              <option value="Sim">Sim</option>
              <option value="Talvez">Talvez</option>
              <option value="Não">Não</option>
            </select>
            <button class="btn primary" data-form-submit="npcs">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <div class="table-wrap">
            <table class="grid" id="npcs-tbl" data-sortable="true">
              <thead><tr><th>Nome</th><th>Detalhe</th><th>Quest</th><th>Localidade</th><th>O que sabe?</th><th>Relevância</th><th class="actions">Ações</th></tr></thead>
              <tbody>
                <tr><td contenteditable="false">Anabella Rosfield</td><td contenteditable="false">Rainha</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false">Disse que as comunicações com a rainha e o rei de Vandholde não estão boas<br>As coisas parecem estranhas em Vanhholde</td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Bartholomeu Hallwinter</td><td contenteditable="false">Guarda Real</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Cassandra Dawnspire</td><td contenteditable="false">Mercadora</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Cedric Highmoor</td><td contenteditable="false">Bibliotecário</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false">Também conhecido como Cedric Allure<br>- Falar para o Rei ou para a rainha que Cedric Allure enviou a gente pela Ordem da Lua (Ordem Secreta), não pode ser falada sobre para qualquer um, não apenas por ser secreta mas por que coisas ruins podem acontecer conosco.</td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Eldric Waverun</td><td contenteditable="false">Ferreiro</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Elwin Rosfield</td><td contenteditable="false">Rei</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false">- Artefatos de poder espalhados pelo continente (fragmentos da espada Dragon Slayer)</td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Lord Caldan Marrick Arrigal (a.k.a. Marrigal Caldas)</td><td contenteditable="false"></td><td contenteditable="false">Tráfico Humano</td><td contenteditable="false">Desconhecida</td><td contenteditable="false"></td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Lorde Himethrol</td><td contenteditable="false">Cavaleiro do Dragão</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Manolo Thrembul</td><td contenteditable="false">Gladiador</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Timothy Burns</td><td contenteditable="false">Bárbaro de Arena</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Talvez" contenteditable="false"><span class="tag maybe">Talvez</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Tristan Kendrick</td><td contenteditable="false">Arquemago</td><td contenteditable="false">O Orbe Danificado</td><td contenteditable="false">Sylvaris</td><td contenteditable="false"></td><td data-rel="Sim" contenteditable="false"><span class="tag yes">Sim</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Veyrik Stormfang</td><td contenteditable="false">Mercador de Armaduras</td><td contenteditable="false"></td><td contenteditable="false">Blivehold</td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Rei Zola</td><td contenteditable="false"></td><td contenteditable="false"></td><td contenteditable="false"></td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
                <tr><td contenteditable="false">Rainha Zeal</td><td contenteditable="false"></td><td contenteditable="false"></td><td contenteditable="false"></td><td contenteditable="false"></td><td data-rel="Não" contenteditable="false"><span class="tag no">Não</span></td><td class="actions"><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></td></tr>
              </tbody>
            </table>
          </div>
        </details>
      </section>

      <!-- Missões -->
      <section class="block" id="missoes-section">
        <details class="section" open>
          <summary><h2 id="missoes-title"><i class="fas fa-tasks"></i> Missões</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-list="missoes">
            <button class="btn small" data-add-toggle="missoes"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small danger" data-reset="missoes"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="missoes">
            <textarea placeholder="Nova missão..."></textarea>
            <button class="btn primary" data-form-submit="missoes">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <ul id="missoes" class="bullets">
            <li><div class="text" contenteditable="false">Alguns dias/semanas atrás, no início do inverno, pessoas relataram aparições de mortos-vivos em torno de Sylvaris e Torntrad.</div><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></li>
            <li><div class="text" contenteditable="false">Orb Guardião entrou em colapso, apagou sua luz e trouxe escuridão para o continente.</div><div class="row-actions"><button class="btn" data-row-edit>Editar</button><button class="btn danger" data-row-remove>Remover</button></div></li>
          </ul>
        </details>
      </section>

      <!-- Timeline / Eventos -->
      <section class="block" id="eventos-section">
        <details class="section" open>
          <summary><h2 id="eventos"><i class="fas fa-hourglass-half"></i> Timeline</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-table="eventos-tbl">
            <button class="btn small" data-add-toggle="eventos"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small danger" data-reset="eventos"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="eventos">
            <input placeholder="Data (ex.: 01/01)" />
            <input placeholder="Evento" />
            <textarea placeholder="Notas"></textarea>
            <button class="btn primary" data-form-submit="eventos">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <div class="table-wrap">
            <table class="grid" id="eventos-tbl" data-sortable="true">
              <thead><tr><th>Data</th><th>Evento</th><th>Notas</th><th class="actions">Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </section>

      <!-- Itens & Tesouros -->
      <section class="block" id="itens-section">
        <details class="section" open>
          <summary><h2 id="itens"><i class="fas fa-gem"></i> Itens & Tesouros</h2></summary>
          <div class="controls">
            <input type="search" placeholder="Buscar nesta seção..." data-table="itens-tbl">
            <button class="btn small" data-edit-toggle="itens-tbl"><i class="fas fa-edit"></i> Modo Edição</button>
            <button class="btn small" data-add-toggle="itens"><i class="fas fa-plus"></i> Adicionar</button>
            <button class="btn small danger" data-reset="itens"><i class="fas fa-undo"></i> Resetar</button>
          </div>
          <div class="inline-form" data-form="itens">
            <input placeholder="Item" />
            <input placeholder="Tipo" />
            <input placeholder="Dono" />
            <input placeholder="Local" />
            <textarea placeholder="Notas"></textarea>
            <button class="btn primary" data-form-submit="itens">Salvar</button>
            <button class="btn" data-form-cancel>Cancelar</button>
          </div>
          <div class="table-wrap">
            <table class="grid" id="itens-tbl" data-sortable="true">
              <thead><tr><th>Item</th><th>Tipo</th><th>Dono</th><th>Local</th><th>Notas</th><th class="actions">Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </section>
    </div>
  </main>
  <div class="snackbar" id="snackbar">Item removido. <button class="btn" id="undoBtn">Desfazer</button></div>

  <script src="/socket.io/socket.io.js">
// === Startup sequence (clean) ===
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Load previously saved content if present
    if (typeof load === 'function') load();

    // Normalize UI (remove duplicated headers/cells and unify action buttons)
    function dedupeHeadersOnce(){
  document.querySelectorAll('table.grid thead').forEach(thead => {
    // Work with thead's single row (create if missing)
    const tr = thead.querySelector('tr') || thead.appendChild(document.createElement('tr'));
    const ths = Array.from(tr.querySelectorAll('th'));
    if (ths.length === 0) return;

    // Keep only non-action headers
    const nonActions = ths.filter(th => !th.classList.contains('actions'));

    // Remove all existing action headers to avoid duplicates
    ths.filter(th => th.classList.contains('actions')).forEach(th => th.remove());

    // Rebuild the row: non-action headers first...
    tr.innerHTML = '';
    nonActions.forEach(th => tr.appendChild(th));

    // ...then ensure exactly one 'Ações' header at the end
    const action = document.createElement('th');
    action.className = 'actions';
    action.textContent = 'Ações';
    tr.appendChild(action);
  });
}
// run normalizers
    try { if (typeof dedupeHeadersOnce === 'function') dedupeHeadersOnce(); } catch(e){}
    try { if (typeof dedupeActionsOnce === 'function') dedupeActionsOnce(); } catch(e){}
    try { if (typeof upgradeActionButtons === 'function') upgradeActionButtons(); } catch(e){}
    try { if (typeof ensureEditablePartyLevels === 'function') ensureEditablePartyLevels(); } catch(e){}
    try { if (typeof fixHeaderGutter === 'function') fixHeaderGutter(); } catch(e){}
    try { if (typeof attachSorting === 'function') document.querySelectorAll('table.grid').forEach(attachSorting); } catch(e){}
    try { if (typeof updateStats === 'function') updateStats(); } catch(e){}

  } finally {
    // allow saves from this point on
    window.__BOOTING__ = false;
    // persist normalized DOM once
    try { if (typeof save === 'function') save(); } catch(e){}
  }
});

</script>
  <script>

    // Boot flag to avoid overwriting saved data during startup
    window.__BOOTING__ = true;
    // ==== Keys & helpers ====
    const LS_PREFIX = 'campanha.v6.3';
    const LS_HTML = LS_PREFIX + '.html';
    const LS_THEME = LS_PREFIX + '.theme';
    const LS_NOTES = LS_PREFIX + '.notes';
    const LS_SESSION = LS_PREFIX + '.session';

    let suppressSync = false; // prevent loops when applying remote state
    
let socket = null;
// connect to Socket.IO on same origin — guarded for local file usage
try {
  if (typeof window !== 'undefined' && typeof window.io === 'function') {
    socket = io();
    // apply incoming state to this client
    socket.on('state:apply', (data) => {
      try { if (!suppressSync && data) applyState(data); } catch(e){ console.error(e); }
    });
  }
} catch (err) {
  console.warn('Socket.IO not available; running offline mode.', err);
}

    const debounce=(fn,wait=500)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}};
    const normalize=(s)=>{try{return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}catch(e){return (s||'').toLowerCase()}};
    const $=(sel,root=document)=>root.querySelector(sel);
const $all=(sel,root=document)=>Array.from(root.querySelectorAll(sel));

// === Added helpers ===
function fixHeaderGutter(){
  $all('.table-wrap').forEach(wrap=>{
    const sbw = wrap.offsetWidth - wrap.clientWidth;
    wrap.style.setProperty('--sbw', (sbw>0?sbw:0)+'px');
  });
}
function ensureEditablePartyLevels(){
  $all('.party-tracker .member-level').forEach(el=>{
    if(!el.hasAttribute('contenteditable')) el.setAttribute('contenteditable','true');
    el.setAttribute('spellcheck','false'); el.setAttribute('tabindex','0');
  });
}
const actionsHTML = () => (
  '<div class="row-actions">'+
    '<button class="btn icon-btn" data-row-edit title="Editar" aria-label="Editar">'+
      '<i class="fa-solid fa-pen-to-square"></i>'+
    '</button>'+
    '<button class="btn icon-btn danger" data-row-remove title="Remover" aria-label="Remover">'+
      '<i class="fa-solid fa-trash"></i>'+
    '</button>'+
  '</div>'
);
// 1) Versão idempotente: sempre reescreve a célula de ações
function upgradeActionButtons(){
  document.querySelectorAll('td.actions, th.actions').forEach(cell => {
    // só normaliza no <td>, no <th> mantemos o rótulo "Ações"
    if (cell.tagName === 'TD'){
      cell.innerHTML = `
        <div class="row-actions">
          <button class="btn icon-btn" data-row-edit title="Editar" aria-label="Editar">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button class="btn icon-btn danger" data-row-remove title="Remover" aria-label="Remover">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>`;
    }
  });
}


    // ==== State build/apply ====
    const tableToJSON=(tbl)=>{const headers=$all('thead th',tbl).map(th=>th.innerText.trim()).filter(h=>h!=='Ações');const rows=$all('tbody tr',tbl).map(tr=>{const obj={};$all('td',tr).forEach((td,i)=>{if(headers[i]) obj[headers[i]]=td.innerHTML.replace(/<br>/g,'\n').trim()});return obj});return {id:tbl.id,headers,rows}};
    const listToJSON=(ul)=>({id:ul.id,items:$all('li .text',ul).map(x=>x.innerText)});
    function buildState(){return{tables:$all('table.grid').map(tableToJSON),lists:$all('ul.bullets').map(listToJSON),notes:$('#quickNotes')?.value||'',session:$('#sessionCount')?.textContent||'1',theme:document.documentElement.getAttribute('data-theme')||'dark'}}
    
function applyState(data){
  if(!data) return;
  suppressSync = true;
  try{
    // 1) Tabelas
    if (Array.isArray(data.tables)) {
      data.tables.forEach(t => {
        const tbl = document.getElementById(t.id);
        if (!tbl) return;
        const thead = tbl.querySelector('thead');
        const tbody = tbl.querySelector('tbody');
        if (thead && Array.isArray(t.headers)) {
          // (Mantém a coluna Ações no fim)
          const headHtml = t.headers.map(h => `<th>${h}</th>`).join('') + '<th class="actions">Ações</th>';
          thead.innerHTML = `<tr>${headHtml}</tr>`;
        }
        if (tbody && Array.isArray(t.rows)) {
          const rowsHtml = t.rows.map(row => {
            const cols = t.headers.map(h => {
              const val = (row[h] || '').replace(/\n/g,'<br>');
              return `<td contenteditable="false">${val}</td>`;
            }).join('');
            return `<tr>${cols}<td class="actions">${actionsHTML()}</td></tr>`;
          }).join('');
          tbody.innerHTML = rowsHtml;
        }
      });
    }
    
    // 2) Listas (ex.: missões)
    if (Array.isArray(data.lists)) {
      data.lists.forEach(lst => {
        const ul = document.getElementById(lst.id);
        if (!ul) return;
        const itemsHtml = (lst.items||[]).map(text => (
          `<li><div class="text" contenteditable="false">${(text||'')}</div>${actionsHTML()}</li>`
        )).join('');
        ul.innerHTML = itemsHtml;
      });
    }

    // 3) Notas rápidas
    if (typeof data.notes === 'string' && document.getElementById('quickNotes')) {
      document.getElementById('quickNotes').value = data.notes;
    }

    // 4) Sessão
    if (data.session && document.getElementById('sessionCount')) {
      document.getElementById('sessionCount').textContent = data.session;
    }

    // 5) Tema
    if (data.theme) {
      document.documentElement.setAttribute('data-theme', data.theme);
    }

    // Reaplicar comportamentos
    try { if (typeof upgradeActionButtons === 'function') upgradeActionButtons(); } catch(e){}
    try { if (typeof attachSorting === 'function') document.querySelectorAll('table.grid').forEach(attachSorting); } catch(e){}
    try { if (typeof updateStats === 'function') updateStats(); } catch(e){}
    try { if (typeof fixHeaderGutter === 'function') fixHeaderGutter(); } catch(e){}
  } finally {
    // libera sync após um pequeno atraso
    setTimeout(()=>{ suppressSync = false; }, 50);
  }
}
function dedupeActionsOnce(){
  document.querySelectorAll('td.actions').forEach(td => {
    // mantém só UM .row-actions
    const blocks = td.querySelectorAll('.row-actions');
    if (blocks.length !== 1) {
      td.innerHTML = ''; // limpa tudo
      td.insertAdjacentHTML('beforeend', `
        <div class="row-actions">
          <button class="btn icon-btn" data-row-edit title="Editar" aria-label="Editar">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button class="btn icon-btn danger" data-row-remove title="Remover" aria-label="Remover">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>`);
    }
  });
}




    const emitUpdateDebounced=debounce(()=>{if(suppressSync||!socket) return; socket.emit('state:update',buildState())},400);

    // ==== Save/Load ====
    function save(){
  if (window.__BOOTING__) { return; }

  const mainEl=$('main'); if(mainEl){localStorage.setItem(LS_HTML,mainEl.innerHTML)}
  localStorage.setItem(LS_THEME,document.documentElement.getAttribute('data-theme')||'dark');
  localStorage.setItem(LS_NOTES,$('#quickNotes')?.value||'');
  localStorage.setItem(LS_SESSION,$('#sessionCount')?.textContent||'1');
  updateStats();
  fixHeaderGutter();            // <-- adicionada
  emitUpdateDebounced();
  // fallback: save via REST too
  try { fetch('/state', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildState()) }); } catch (e) { console.warn('POST /state failed', e); }
}
    function load(){const html=localStorage.getItem(LS_HTML); if(html){$('main').innerHTML=html}const theme=localStorage.getItem(LS_THEME); if(theme){document.documentElement.setAttribute('data-theme',theme)}const notes=localStorage.getItem(LS_NOTES); if(notes&&$('#quickNotes')) $('#quickNotes').value=notes;const sess=localStorage.getItem(LS_SESSION); if(sess) $('#sessionCount').textContent=sess}

    // ==== Sorting ====
    function attachSorting(tbl){const ths=$all('thead th',tbl);ths.forEach((th,idx)=>{if(th.classList.contains('actions')) return;th.addEventListener('click',()=>{const dir=th.classList.contains('sort-asc')?'desc':'asc';ths.forEach(t=>t.classList.remove('sort-asc','sort-desc'));th.classList.add(dir==='asc'?'sort-asc':'sort-desc');const rows=$all('tbody tr',tbl);rows.sort((a,b)=>{const ta=a.children[idx].innerText.trim(); const tb=b.children[idx].innerText.trim(); return dir==='asc'?ta.localeCompare(tb):tb.localeCompare(ta)});const tbody=$('tbody',tbl);rows.forEach(r=>tbody.appendChild(r));save()})})}

    // ==== Snackbar / Undo ====
    let undoStack=[];function showSnackbar(){const sb=$('#snackbar'); if(!sb) return; sb.style.display='flex'; clearTimeout(sb._t); sb._t=setTimeout(()=>sb.style.display='none',5000)}
    $('#undoBtn')?.addEventListener('click',()=>{const item=undoStack.pop(); if(!item) return; if(item.type==='row'){item.tbody.insertBefore(item.node,item.nextSibling)}else if(item.type==='li'){item.ul.insertBefore(item.node,item.nextSibling)}save(); $('#snackbar').style.display='none'});


// ==== Add missing form helpers (toggleForm & submitForm) ====
function toggleForm(section){
  const form = document.querySelector(`.inline-form[data-form="${section}"]`);
  if(!form) return;
  form.style.display = (form.style.display === 'flex') ? 'none' : 'flex';
}

function submitForm(section){
  const form = document.querySelector(`.inline-form[data-form="${section}"]`);
  if(!form) return;

  // Map targets
  const targets = {
    detalhes: '#detalhes-tbl tbody',
    lugares:  '#lugares-tbl tbody',
    npcs:     '#npcs-tbl tbody',
    eventos:  '#eventos-tbl tbody',
    itens:    '#itens-tbl tbody',
    missoes:  '#missoes'
  };
  const targetSel = targets[section];
  if(!targetSel) return;
  const target = document.querySelector(targetSel);
  if(!target) return;

  // Helper: clear and close
  const done = () => {
    form.querySelectorAll('input, textarea').forEach(el => el.value = '');
    const sel = form.querySelector('select');
    if(sel) sel.selectedIndex = 0;
    form.style.display = 'none';
    if (typeof updateStats === 'function') updateStats();
    if (typeof fixHeaderGutter === 'function') fixHeaderGutter();
    if (typeof upgradeActionButtons === 'function') upgradeActionButtons();
    if (typeof save === 'function') save();
  };

  if(section === 'missoes'){
    const text = (form.querySelector('textarea')?.value || '').trim();
    if(!text) return;
    const li = document.createElement('li');
    li.innerHTML = `<div class="text" contenteditable="false">${text}</div>${actionsHTML()}`;
    target.appendChild(li);
    return done();
  }

  // Build table row per section
  const tr = document.createElement('tr');

  if(section === 'detalhes'){
    const [who, info, symbol, faction] = [
      form.querySelector('input[placeholder="Quem sabe a info?"]')?.value || '',
      form.querySelector('textarea[placeholder="Informação"]')?.value || '',
      form.querySelector('input[placeholder="Símbolo"]')?.value || '',
      form.querySelector('input[placeholder="Facção"]')?.value || ''
    ];
    [who, info, symbol, faction].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      td.setAttribute('contenteditable', 'false');
      tr.appendChild(td);
    });
  }
  else if(section === 'lugares'){
    const nome = form.querySelector('input[placeholder="Local"]')?.value || '';
    const visitado = form.querySelector('select')?.value || '—';
    [nome, visitado].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      td.setAttribute('contenteditable', 'false');
      tr.appendChild(td);
    });
  }
  else if(section === 'npcs'){
    const nome = form.querySelector('input[placeholder="Nome"]')?.value || '';
    const detalhe = form.querySelector('input[placeholder="Detalhe"]')?.value || '';
    const quest = form.querySelector('input[placeholder="Quest"]')?.value || '';
    const localidade = form.querySelector('input[placeholder="Localidade"]')?.value || '';
    const sabe = form.querySelector('textarea[placeholder="O que sabe?"]')?.value || '';
    const relev = form.querySelector('select')?.value || 'Não';

    // 5 primeiras colunas como texto
    [nome, detalhe, quest, localidade, sabe].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      td.setAttribute('contenteditable', 'false');
      tr.appendChild(td);
    });

    // Coluna de relevância com <span class="tag ...">
    const tdRel = document.createElement('td');
    tdRel.setAttribute('data-rel', relev);
    tdRel.setAttribute('contenteditable', 'false');
    const map = { 'Sim': 'yes', 'Talvez': 'maybe', 'Não': 'no' };
    const cls = map[relev] || 'no';
    const span = document.createElement('span');
    span.className = `tag ${cls}`;
    span.textContent = relev;
    tdRel.appendChild(span);
    tr.appendChild(tdRel);
  }
  else if(section === 'eventos'){
    const data = form.querySelector('input[placeholder="Data (ex.: 01/01)"]')?.value || '';
    const evento = form.querySelector('input[placeholder="Evento"]')?.value || '';
    const notas = form.querySelector('textarea[placeholder="Notas"]')?.value || '';
    [data, evento, notas].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      td.setAttribute('contenteditable', 'false');
      tr.appendChild(td);
    });
  }
  else if(section === 'itens'){
    const item = form.querySelector('input[placeholder="Item"]')?.value || '';
    const tipo = form.querySelector('input[placeholder="Tipo"]')?.value || '';
    const dono = form.querySelector('input[placeholder="Dono"]')?.value || '';
    const local = form.querySelector('input[placeholder="Local"]')?.value || '';
    const notas = form.querySelector('textarea[placeholder="Notas"]')?.value || '';
    [item, tipo, dono, local, notas].forEach(val => {
      const td = document.createElement('td');
      td.textContent = val;
      td.setAttribute('contenteditable', 'false');
      tr.appendChild(td);
    });
  } else {
    // Fallback genérico: cria colunas para todos os inputs/textarea/select, exceto botões
    form.querySelectorAll('input, textarea, select').forEach(inp => {
      const td = document.createElement('td');
      td.textContent = (inp.tagName === 'SELECT') ? inp.value : (inp.value || '');
      td.setAttribute('contenteditable','false');
      tr.appendChild(td);
    });
  }

  // Coluna de ações
  const tdActions = document.createElement('td');
  tdActions.className = 'actions';
  tdActions.innerHTML = actionsHTML();
  tr.appendChild(tdActions);

  target.appendChild(tr);
  return done();
}
// ==== end helpers ====

// ==== Stats updater ====
function updateStats(){
  const npcCount = document.querySelectorAll('#npcs-tbl tbody tr').length;
  const locationCount = document.querySelectorAll('#lugares-tbl tbody tr').length;
  const questCount = document.querySelectorAll('#missoes li').length;
  const itemCount = document.querySelectorAll('#itens-tbl tbody tr').length;
  const set = (id,val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
  set('npcCount', npcCount);
  set('locationCount', locationCount);
  set('questCount', questCount);
  set('itemCount', itemCount);
}
// ==== end stats ====

// run once on load
document.addEventListener('DOMContentLoaded',()=>{
  try { dedupeActionsOnce?.(); save?.(); } catch(e){}
  if(typeof updateStats==='function') updateStats();
  if(typeof upgradeActionButtons==='function') upgradeActionButtons();
  document.querySelectorAll('table.grid').forEach(tbl=>{
    if(typeof attachSorting==='function') attachSorting(tbl);
  });
});

// ==== Add missing form helpers (toggleForm & submitForm) ====
if (typeof toggleForm !== 'function') {
  function toggleForm(section){
    const form = document.querySelector(`.inline-form[data-form="${section}"]`);
    if(!form) return;
    form.style.display = (form.style.display === 'flex') ? 'none' : 'flex';
    if(form.style.display === '') form.style.display = 'flex';
  }
}

if (typeof submitForm !== 'function') {
  function submitForm(section){
    const form = document.querySelector(`.inline-form[data-form="${section}"]`);
    if(!form) return;

    const targets = {
      detalhes: '#detalhes-tbl tbody',
      lugares:  '#lugares-tbl tbody',
      npcs:     '#npcs-tbl tbody',
      eventos:  '#eventos-tbl tbody',
      itens:    '#itens-tbl tbody',
      missoes:  '#missoes'
    };
    const targetSel = targets[section];
    const target = targetSel ? document.querySelector(targetSel) : null;
    if(!target) return;

    const done = () => {
      form.querySelectorAll('input, textarea').forEach(el => el.value = '');
      const sel = form.querySelector('select'); if (sel) sel.selectedIndex = 0;
      form.style.display = 'none';
      if (typeof updateStats === 'function') updateStats();
      if (typeof fixHeaderGutter === 'function') fixHeaderGutter();
      if (typeof upgradeActionButtons === 'function') upgradeActionButtons();
      if (typeof save === 'function') save();
    };

    if(section === 'missoes'){
      const text = (form.querySelector('textarea')?.value || '').trim();
      if(!text) return;
      const li = document.createElement('li');
      li.innerHTML = `<div class="text" contenteditable="false">${text}</div>${actionsHTML()}`;
      target.appendChild(li);
      return done();
    }

    const tr = document.createElement('tr');

    if(section === 'detalhes'){
      const [who, info, symbol, faction] = [
        form.querySelector('input[placeholder="Quem sabe a info?"]')?.value || '',
        form.querySelector('textarea[placeholder="Informação"]')?.value || '',
        form.querySelector('input[placeholder="Símbolo"]')?.value || '',
        form.querySelector('input[placeholder="Facção"]')?.value || ''
      ];
      [who, info, symbol, faction].forEach(val => {
        const td = document.createElement('td'); td.textContent = val; td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });
    }
    else if(section === 'lugares'){
      const nome = form.querySelector('input[placeholder="Local"]')?.value || '';
      const visitado = form.querySelector('select')?.value || '—';
      [nome, visitado].forEach(val => {
        const td = document.createElement('td'); td.textContent = val; td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });
    }
    else if(section === 'npcs'){
      const nome = form.querySelector('input[placeholder="Nome"]')?.value || '';
      const detalhe = form.querySelector('input[placeholder="Detalhe"]')?.value || '';
      const quest = form.querySelector('input[placeholder="Quest"]')?.value || '';
      const localidade = form.querySelector('input[placeholder="Localidade"]')?.value || '';
      const sabe = form.querySelector('textarea[placeholder="O que sabe?"]')?.value || '';
      const relev = form.querySelector('select')?.value || 'Não';

      [nome, detalhe, quest, localidade, sabe].forEach(val => {
        const td = document.createElement('td'); td.textContent = val; td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });

      const tdRel = document.createElement('td');
      tdRel.setAttribute('data-rel', relev); tdRel.setAttribute('contenteditable','false');
      const map = { 'Sim': 'yes', 'Talvez': 'maybe', 'Não': 'no' };
      const span = document.createElement('span'); span.className = `tag ${map[relev] || 'no'}`; span.textContent = relev;
      tdRel.appendChild(span); tr.appendChild(tdRel);
    }
    else if(section === 'eventos'){
      const data = form.querySelector('input[placeholder="Data (ex.: 01/01)"]')?.value || '';
      const evento = form.querySelector('input[placeholder="Evento"]')?.value || '';
      const notas = form.querySelector('textarea[placeholder="Notas"]')?.value || '';
      [data, evento, notas].forEach(val => {
        const td = document.createElement('td'); td.textContent = val; td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });
    }
    else if(section === 'itens'){
      const item = form.querySelector('input[placeholder="Item"]')?.value || '';
      const tipo = form.querySelector('input[placeholder="Tipo"]')?.value || '';
      const dono = form.querySelector('input[placeholder="Dono"]')?.value || '';
      const local = form.querySelector('input[placeholder="Local"]')?.value || '';
      const notas = form.querySelector('textarea[placeholder="Notas"]')?.value || '';
      [item, tipo, dono, local, notas].forEach(val => {
        const td = document.createElement('td'); td.textContent = val; td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });
    } else {
      form.querySelectorAll('input, textarea, select').forEach(inp => {
        const td = document.createElement('td');
        td.textContent = (inp.tagName === 'SELECT') ? inp.value : (inp.value || '');
        td.setAttribute('contenteditable','false'); tr.appendChild(td);
      });
    }

    const tdActions = document.createElement('td');
    tdActions.className = 'actions'; tdActions.innerHTML = actionsHTML(); tr.appendChild(tdActions);
    target.appendChild(tr);
    return done();
  }
}
// ==== end helpers ====

// ==== Stats updater ====
if (typeof updateStats !== 'function') {
  function updateStats(){
    const bySelCount = (sel) => document.querySelectorAll(sel).length;
    const npcs = bySelCount('#npcs-tbl tbody tr');
    const locais = bySelCount('#lugares-tbl tbody tr');
    const missoes = bySelCount('#missoes li');
    const itens = bySelCount('#itens-tbl tbody tr');

    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = String(val); };
    set('npcCount', npcs);
    set('locationCount', locais);
    set('questCount', missoes);
    set('itemCount', itens);
  }
}
// ==== end stats ====

// ==== Initializer on load ====
window.addEventListener('DOMContentLoaded', () => {
  try { dedupeActionsOnce?.(); save?.(); } catch(e){}
  // attach sorting to existing tables (if not already attached)
  document.querySelectorAll('table.grid').forEach(tbl => {
    try { if (typeof attachSorting === 'function') attachSorting(tbl); } catch(e){}
  });
  try { if (typeof upgradeActionButtons === 'function') upgradeActionButtons(); } catch(e){}
  try { if (typeof ensureEditablePartyLevels === 'function') ensureEditablePartyLevels(); } catch(e){}
  try { if (typeof updateStats === 'function') updateStats(); } catch(e){}
  try { if (typeof fixHeaderGutter === 'function') fixHeaderGutter(); } catch(e){}
});
// ==== Event delegation — bloco único e válido ====
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;

  // --- Dados rápidos (animação + crítico/falha) ---
  if (btn.classList.contains('dice-btn')) {
    const n = parseInt(btn.dataset.dice || '20', 10) || 20;
    const resEl = document.getElementById('diceResult');
    const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (resEl && resEl.dataset.rolling === '1') return; // evita spam

    const finish = (roll) => {
      if (resEl) {
        resEl.textContent = `d${n}: ${roll}`;
        resEl.classList.remove('rolling', 'crit-max', 'crit-min');
        delete resEl.dataset.rolling;
      }
      btn.classList.remove('rolling', 'crit-max', 'crit-min');

      // efeitos de crítico/falha
      if (roll === n || roll === 1) {
        const cls = (roll === n) ? 'crit-max' : 'crit-min';
        btn.classList.add(cls);
        if (resEl) resEl.classList.add(cls);
        setTimeout(() => {
          btn.classList.remove(cls);
          if (resEl) resEl.classList.remove(cls);
        }, 900);
      }
    };

    if (reduceMotion) { finish(1 + Math.floor(Math.random() * n)); return; }

    if (resEl) { resEl.dataset.rolling = '1'; resEl.classList.add('rolling'); }
    btn.classList.add('rolling');

    const duration = 700;
    const t0 = performance.now();
    let rafId = 0;

    const tick = () => {
      const t = performance.now() - t0;
      if (t < duration) {
        const temp = 1 + Math.floor(Math.random() * n);
        if (resEl) resEl.textContent = `d${n}: ${temp}`;
        rafId = requestAnimationFrame(tick);
      } else {
        cancelAnimationFrame(rafId);
        finish(1 + Math.floor(Math.random() * n));
      }
    };
    rafId = requestAnimationFrame(tick);
    return;
  }

  // --- Header ---
  if (btn.id === 'themeToggle') {
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
    if (typeof save === 'function') save();
    return;
  }
  if (btn.id === 'exportJson') {
    const data = typeof buildState === 'function' ? buildState() : null;
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'campanha-data.json'; a.click();
    return;
  }
  if (btn.id === 'importJson') {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = '.json,application/json';
    inp.onchange = e => {
      const f = e.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try { const data = JSON.parse(r.result); if (typeof applyState==='function') applyState(data); if (typeof save==='function') save(); alert('Importado com sucesso!'); }
        catch (err) { alert('Falha ao importar: ' + err.message); }
      };
      r.readAsText(f);
    };
    inp.click();
    return;
  }
  if (btn.id === 'exportCsv') {
    let out = '';
    document.querySelectorAll('table.grid').forEach(tbl => {
      out += `# ${tbl.id}\n`;
      const headers = Array.from(tbl.querySelectorAll('thead th')).map(th => th.innerText.trim()).join(',');
      out += headers + '\n';
      tbl.querySelectorAll('tbody tr').forEach(tr => {
        const tds = Array.from(tr.querySelectorAll('td'));
        const cols = tds.slice(0, tds.length - 1).map(td => `"${td.innerText.replace(/"/g,'""')}"`).join(',');
        out += cols + '\n';
      });
      out += '\n';
    });
    const blob = new Blob([out], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'campanha-tabelas.csv'; a.click();
    return;
  }
  if (btn.id === 'resetAll') {
    if (confirm('Resetar tudo para a versão padrão?')) {
      localStorage.removeItem(LS_HTML);
      localStorage.removeItem(LS_THEME);
      localStorage.removeItem(LS_NOTES);
      localStorage.removeItem(LS_SESSION);
      location.reload();
    }
    return;
  }

  // --- Inline controls / formulários ---
  if (btn.hasAttribute('data-form-cancel')) { const box=btn.closest('.inline-form'); if (box) box.style.display='none'; return; }

  if (btn.hasAttribute('data-edit-toggle')) {
    const id = btn.getAttribute('data-edit-toggle');
    const editing = btn.classList.toggle('active');
    document.querySelectorAll('#' + id + ' tbody td:not(.actions)')
      .forEach(td => td.setAttribute('contenteditable', editing ? 'true' : 'false'));
    btn.innerHTML = editing ? '<i class="fas fa-lock"></i> Bloquear' : '<i class="fas fa-edit"></i> Modo Edição';
    if (!editing && typeof save==='function') save();
    return;
  }

  if (btn.hasAttribute('data-add-toggle')) { if (typeof toggleForm==='function') toggleForm(btn.getAttribute('data-add-toggle')); return; }
  if (btn.hasAttribute('data-form-submit')) { if (typeof submitForm==='function') submitForm(btn.getAttribute('data-form-submit')); return; }

  if (btn.hasAttribute('data-export-csv')) {
    const id = btn.getAttribute('data-export-csv');
    const tbl = document.getElementById(id); if (!tbl) return;
    let out = '';
    const headers = Array.from(tbl.querySelectorAll('thead th')).map(th => th.innerText.trim()).join(',');
    out += headers + '\n';
    tbl.querySelectorAll('tbody tr').forEach(tr => {
      const tds = Array.from(tr.querySelectorAll('td'));
      const cols = tds.slice(0, tds.length - 1).map(td => `"${td.innerText.replace(/"/g,'""')}"`).join(',');
      out += cols + '\n';
    });
    const blob = new Blob([out], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = id + '.csv'; a.click();
    return;
  }

  if (btn.hasAttribute('data-reset')) {
    const sec = btn.getAttribute('data-reset');
    if (!confirm('Resetar esta seção?')) return;
    if (['detalhes','lugares','npcs','eventos','itens'].includes(sec)) {
      const map = { detalhes:'#detalhes-tbl tbody', lugares:'#lugares-tbl tbody', npcs:'#npcs-tbl tbody', eventos:'#eventos-tbl tbody', itens:'#itens-tbl tbody' };
      const sel = map[sec]; if (sel) { const el = document.querySelector(sel); if (el) el.innerHTML=''; }
    } else if (sec === 'missoes') {
      const ul = document.getElementById('missoes'); if (ul) ul.innerHTML='';
    }
    if (typeof save==='function') save();
    return;
  }

  if (btn.hasAttribute('data-row-remove')) {
    const tr = e.target.closest('tr'); const li = e.target.closest('li');
    if (tr) { const tb = tr.parentElement; const next = tr.nextSibling; undoStack.push({type:'row', node:tr, tbody:tb, nextSibling:next}); tr.remove(); if (typeof save==='function') save(); if (typeof showSnackbar==='function') showSnackbar(); return; }
    if (li) { const ul = li.parentElement; const next = li.nextSibling; undoStack.push({type:'li', node:li, ul, nextSibling:next}); li.remove(); if (typeof save==='function') save(); if (typeof showSnackbar==='function') showSnackbar(); return; }
  }

  if (btn.hasAttribute('data-row-edit')) {
  const tr = e.target.closest('tr');
  if (tr) {
    const cells = tr.querySelectorAll('td:not(.actions)');
    const willEdit = cells[0]?.getAttribute('contenteditable') !== 'true';

    cells.forEach(td => td.setAttribute('contenteditable', willEdit ? 'true' : 'false'));

    // mantém ícones (lápis ↔ check) em vez de texto
    btn.innerHTML = willEdit
      ? '<i class="fa-solid fa-check"></i>'
      : '<i class="fa-solid fa-pen-to-square"></i>';
    btn.setAttribute('title', willEdit ? 'Concluir' : 'Editar');
    btn.setAttribute('aria-label', willEdit ? 'Concluir' : 'Editar');

    if (!willEdit) save();   // só salva ao concluir
    return;
  }

  // listas (missões etc.)
  const li = e.target.closest('li');
  if (li) {
    const el = li.querySelector('.text');
    const willEdit = el.getAttribute('contenteditable') !== 'true';
    el.setAttribute('contenteditable', willEdit ? 'true' : 'false');

    btn.innerHTML = willEdit
      ? '<i class="fa-solid fa-check"></i>'
      : '<i class="fa-solid fa-pen-to-square"></i>';
    btn.setAttribute('title', willEdit ? 'Concluir' : 'Editar');
    btn.setAttribute('aria-label', willEdit ? 'Concluir' : 'Editar');

    if (!willEdit) save();
    return;
  }
}

});
  
const MIG_DEDUPE = LS_PREFIX + '.migrated.dedupe.v1';
window.addEventListener('DOMContentLoaded', () => {
  if (!localStorage.getItem(MIG_DEDUPE)) {
    try { upgradeActionButtons?.(); dedupeActionsOnce?.(); save?.(); } catch(e){}
    localStorage.setItem(MIG_DEDUPE, '1');
  }
});

</script>
</body>
</html>
